<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Badge Selling Record</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>Badge Selling Record</h1>
        <div class="form-group">
            <label for="date">Set Date:</label>
            <input type="date" id="date">
        </div>
        <div class="form-group">
            <label for="item">Select Item:</label>
            <select id="item">
                <option value="TH practice">TH practice - RM8</option>
                <option value="TH exam">TH exam - RM8.50</option>
                <option value="Circuit">Circuit - RM5</option>
                <option value="Breadboard">Breadboard - RM10</option>
                <option value="SMD practice">SMD practice - RM2.50</option>
                <option value="SMD exam">SMD exam - RM3.50</option>
                <option value="Cutter">Cutter - RM10</option>
                <option value="Plier">Plier - RM10</option>
                <option value="Perf 5x7">Perf 5x7 - RM2</option>
                <option value="Perf 7x9">Perf 7x9 - RM3</option>
                <option value="Exam Pack 2">Exam Pack 2 - RM3.50</option>
                <option value="Log book">Log book - RM1.60</option>
                <option value="Tweezer">Tweezer - RM4</option>
                <option value="Acrylic">Acrylic - RM7</option>
                <option value="Arduino Pro Micro">Arduino Pro Micro - RM20</option>
                <option value="Soldering Lead">Soldering Lead - RM3</option>
                <option value="Keyboard Badge">Keyboard Badge - RM8</option>
                <option value="Resistors">Resistors - RM2</option>
                <option value="Key Cap">Key Cap - RM1</option>
                <option value="Screws and Golden nut">Screws and Golden nut - RM1</option>
                <option value="Switches">Switches - RM0.50</option>
                <option value="Potential Meter">Potential Meter - RM1</option>
            </select>
        </div>
        <div class="form-group">
            <label for="quantity">Quantity:</label>
            <button onclick="changeQuantity(-1)">-</button>
            <input type="number" id="quantity" min="1" value="1">
            <button onclick="changeQuantity(1)">+</button>
        </div>
        <div class="form-group">
            <label for="studentNumber">Student Number:</label>
            <input type="text" id="studentNumber">
        </div>
        <button onclick="addSale()">Add Sale</button>

        <div class="tables">
            <div class="table-wrapper">
                <h2>Recorded Sales</h2>
                <table id="salesTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Quantity</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Sales records will appear here -->
                    </tbody>
                    
                </table>
            </div>

            <div class="table-wrapper">
                <h2>Pin of Shame</h2>
                <table id="shameTable">
                    <thead>
                        <tr>
                            <th>Student Number</th>
                            <th>Amount Owed (RM)</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Unpaid records will appear here -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="form-group">
            <label for="clearMonth">Clear Sales for Month:</label>
            <input type="month" id="clearMonth">
        </div>
        <button onclick="clearSales()">Clear Sales</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCemzu_stNmHaHfGHzmi_59k0XGT4ivEy4",
            authDomain: "badgeselling-e5a2d.firebaseapp.com",
            databaseURL: "https://badgeselling-e5a2d-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "badgeselling-e5a2d",
            storageBucket: "badgeselling-e5a2d.appspot.com",
            messagingSenderId: "80085468094",
            appId: "1:80085468094:web:009245082abb6d95b06fef",
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        document.addEventListener('DOMContentLoaded', (event) => {
            const dateInput = document.getElementById('date');
            const today = new Date().toISOString().split('T')[0];
            dateInput.value = today;
        });

        window.addSale = function() {
            const date = document.getElementById('date').value;
            const item = document.getElementById('item').value;
            const quantity = parseInt(document.getElementById('quantity').value);
            const studentNumber = document.getElementById('studentNumber').value;

            if (!date || !item || isNaN(quantity) || quantity <= 0 || !studentNumber) {
                alert('Please select a date, item, valid quantity, and enter a student number.');
                return;
            }

            const salesRef = ref(database, 'salesRecords');
            const newSaleRef = push(salesRef);
            set(newSaleRef, { date, item, quantity, studentNumber });

            addToShame(studentNumber, item, quantity);

            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
            document.getElementById('item').value = '';
            document.getElementById('quantity').value = 1;
            document.getElementById('studentNumber').value = '';

            displaySales();
            displayShame();
        };

        window.changeQuantity = function(change) {
            const quantityInput = document.getElementById('quantity');
            let quantity = parseInt(quantityInput.value);
            quantity += change;
            if (quantity < 1) quantity = 1;
            quantityInput.value = quantity;
        };

        function addToShame(studentNumber, item, quantity) {
            const shameRef = ref(database, 'shameRecords');
            onValue(shameRef, (snapshot) => {
                let recordFound = false;
                const records = snapshot.val();

                if (records) {
                    Object.entries(records).forEach(([id, record]) => {
                        if (record.studentNumber === studentNumber) {
                            recordFound = true;
                            const updatedAmount = record.amount + calculateAmount(item, quantity);
                            update(ref(database, 'shameRecords/' + id), { amount: updatedAmount });
                        }
                    });
                }

                if (!recordFound) {
                    const newShameRef = push(shameRef);
                    set(newShameRef, { studentNumber, amount: calculateAmount(item, quantity) });
                }
            }, { onlyOnce: true });
        }

        function calculateAmount(item, quantity) {
            const price = parseFloat(item.split('- RM')[1]);
            return price * quantity;
        }

        function displaySales() {
            const salesTableBody = document.querySelector('#salesTable tbody');
            salesTableBody.innerHTML = '';

            const salesRef = ref(database, 'salesRecords');
            onValue(salesRef, (snapshot) => {
                const records = snapshot.val();
                if (records) {
                    let lastDate = ''; // To keep track of the last displayed date
                    Object.entries(records).forEach(([id, record]) => {
                        if (record.date !== lastDate) {
                            // Add a new row for the new date
                            const dateRow = document.createElement('tr');
                            dateRow.className = 'date-row';
                            dateRow.innerHTML = `<td colspan="3">${record.date}</td>`;
                            salesTableBody.appendChild(dateRow);
                            lastDate = record.date;
                        }

                        // Add the sale row with `+` and `-` buttons in the "Action" column
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${record.item}</td>
                            <td>${record.quantity}</td>
                            <td>
                                <button onclick="changeQuantityInTable('${id}', -1)">-</button>
                                <button onclick="changeQuantityInTable('${id}', 1)">+</button>
                            </td>
                        `;
                        salesTableBody.appendChild(row);
                    });
                }
            });
        }



        window.changeQuantityInTable = function(id, change) {
            const salesRef = ref(database, 'salesRecords/' + id);
            onValue(salesRef, (snapshot) => {
                const record = snapshot.val();
                let newQuantity = record.quantity + change;
                if (newQuantity < 1) newQuantity = 1;
                update(salesRef, { quantity: newQuantity });
                displaySales();
            }, { onlyOnce: true });
        };

        function displayShame() {
            const shameTableBody = document.querySelector('#shameTable tbody');
            shameTableBody.innerHTML = '';

            const shameRef = ref(database, 'shameRecords');
            onValue(shameRef, (snapshot) => {
                const records = snapshot.val();
                if (records) {
                    Object.entries(records).forEach(([id, record]) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${record.studentNumber}</td>
                            <td>${record.amount.toFixed(2)}</td>
                            <td>
                                <button onclick="removeFromShame('${id}')">Paid</button>
                            </td>
                        `;
                        shameTableBody.appendChild(row);
                    });
                }
            });
        }

        window.removeSale = function(id) {
            const salesRef = ref(database, 'salesRecords/' + id);
            remove(salesRef);
            displaySales();
        };

        window.removeFromShame = function(id) {
            const shameRef = ref(database, 'shameRecords/' + id);
            remove(shameRef);
            displayShame();
        };

        window.clearSales = function() {
            const clearMonth = document.getElementById('clearMonth').value;
            if (!clearMonth) {
                alert('Please select a month.');
                return;
            }

            const salesRef = ref(database, 'salesRecords');
            onValue(salesRef, (snapshot) => {
                const records = snapshot.val();
                if (records) {
                    Object.entries(records).forEach(([id, record]) => {
                        if (record.date.startsWith(clearMonth)) {
                            remove(ref(database, 'salesRecords/' + id));
                        }
                    });
                }
                displaySales();
            }, { onlyOnce: true });
        };

        displaySales();
        displayShame();
    </script>
</body>
</html>
